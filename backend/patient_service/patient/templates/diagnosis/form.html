<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Chẩn đoán sức khỏe</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 h-screen flex font-sans">
    <!-- Sidebar -->
    <aside class="w-64 bg-[#4F6EF7] text-white flex flex-col p-5">
      <h2 class="text-xl font-bold mb-8 mt-4">🧑‍⚕️ Trang Chủ</h2>
      <nav class="space-y-3 text-md font-medium">
        <a
          href="http://127.0.0.1:7003/api/patients/appointment_view/"
          class="flex items-center gap-2 hover:bg-white/10 rounded px-3 py-2"
          >📅 Lịch sử đặt lịch</a
        >
        <a
          href="http://127.0.0.1:7003/api/patients/diagnosis_form_view/"
          class="flex items-center gap-2 hover:bg-white/10 rounded px-3 py-2"
          >📝 Chẩn đoán sức khỏe</a
        >
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
      <!-- Header -->
      <header
        class="flex items-center justify-between px-6 py-4 bg-white border-b shadow-sm"
      >
        <input
          type="text"
          placeholder="🔍 Search..."
          class="border border-gray-300 rounded px-4 py-1 w-1/3 focus:outline-none focus:ring focus:border-blue-400"
        />
        <div class="flex items-center gap-4">
          <span id="user-info" class="text-sm text-gray-700 font-medium"
            >👤 Tài khoản</span
          >
          <button
            onclick="handleLogout()"
            class="bg-[#4F6EF7] text-white px-3 py-1 rounded hover:bg-blue-700 text-sm"
          >
            📕 Đăng xuất
          </button>
        </div>
      </header>

      <!-- Content -->
      <main class="flex-1 flex justify-center items-center py-8">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
          <h1 class="text-2xl font-bold mb-6 text-center text-blue-600">
            🧠 Chẩn đoán sức khỏe
          </h1>
          <form id="symptomForm">
            <p class="font-semibold mb-4">Chọn các triệu chứng bạn đang gặp:</p>
            <label class="block mb-2"
              ><input
                type="checkbox"
                name="symptom1"
                value="1"
                class="mr-2"
              />Sốt (sốt cao, ớn lạnh)</label
            >
            <label class="block mb-2"
              ><input
                type="checkbox"
                name="symptom2"
                value="1"
                class="mr-2"
              />Ho (ho khan hoặc có đờm)</label
            >
            <label class="block mb-2"
              ><input
                type="checkbox"
                name="symptom3"
                value="1"
                class="mr-2"
              />Hắt hơi (nghẹt mũi, hắt hơi liên tục)</label
            >
            <label class="block mb-2"
              ><input
                type="checkbox"
                name="symptom4"
                value="1"
                class="mr-2"
              />Mệt mỏi (yếu cơ, uể oải)</label
            >
            <label class="block mb-2"
              ><input
                type="checkbox"
                name="symptom5"
                value="1"
                class="mr-2"
              />Mất vị giác (không cảm nhận được mùi vị)</label
            >
            <label class="block mb-2"
              ><input
                type="checkbox"
                name="symptom6"
                value="1"
                class="mr-2"
              />Ngứa mắt (mắt đỏ, ngứa hoặc chảy nước mắt)</label
            >
            <button
              type="submit"
              class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 mt-4"
            >
              🧪 Chẩn đoán
            </button>
          </form>
          <div id="result" class="mt-6 p-4 rounded-lg hidden"></div>
        </div>
      </main>
    </div>

    <script>
      async function loadPatientInfo() {
        const userId = localStorage.getItem("userId");
        const username = localStorage.getItem("username");
        console.log("Username", username);

        document.getElementById("user-info").innerText =
          "👨‍⚕️ " + (username || "Tài khoản");
      }

      function handleLogout() {
        localStorage.clear();
        window.location.href = "http://127.0.0.1:7000/api/auth/login_view/";
      }

      loadPatientInfo();

      const form = document.getElementById("symptomForm");
      const resultBox = document.getElementById("result");

      const diseaseInfo = {
        Flu: {
          name: "Cúm mùa",
          desc: "Bệnh nhiễm siêu vi thông thường, gây sốt, mệt mỏi, đau đầu, ho.",
          care: "Nghỉ ngơi nhiều, uống nhiều nước, có thể dùng Tamiflu.",
        },
        Cold: {
          name: "Cảm lạnh",
          desc: "Bệnh nhiễm virus nhẹ gây hắt hơi, nghẹt mũi, ho nhẹ và đau họng.",
          care: "Uống nhiều nước, ngủ đủ, dùng thuốc giảm triệu chứng như Paracetamol.",
        },
        "COVID-19": {
          name: "COVID-19",
          desc: "Bệnh do virus SARS-CoV-2 gây ra, có thể gây sốt, mất vị giác, khó thở.",
          care: "Cách ly, theo dõi nhiệt độ, dùng thuốc hạ sốt và theo dõi oxy máu.",
        },
        Allergy: {
          name: "Dị ứng",
          desc: "Phản ứng của hệ miễn dịch với các yếu tố như phấn hoa, lông động vật.",
          care: "Tránh dị nguyên, dùng thuốc kháng histamin như Loratadine, Cetirizine.",
        },
      };

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const checkboxes = form.querySelectorAll('input[type="checkbox"]');
        const symptoms = Array.from(checkboxes).map((box) =>
          box.checked ? 1 : 0
        );
        const data = { symptoms };

        const res = await fetch("/api/diagnosis/predict/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        const json = await res.json();
        resultBox.classList.remove("hidden");

        if (json.error) {
          resultBox.className = "mt-6 p-4 rounded-lg bg-red-100 text-red-700";
          resultBox.innerHTML = "❌ " + json.error;
          return;
        }

        const disease = diseaseInfo[json.diagnosis];
        resultBox.className = "mt-6 p-4 rounded-lg bg-green-100 text-green-700";
        resultBox.innerHTML = `
        🧬 <strong>Bệnh chẩn đoán:</strong> <em>${disease.name}</em><br><br>
        🔍 <strong>Thông tin:</strong> ${disease.desc}<br>
        💡 <strong>Chăm sóc:</strong> ${disease.care}<br>
        🧫 <strong>Xét nghiệm đề xuất:</strong> ${json.test_suggested}<br>
        💊 <strong>Thuốc đề xuất:</strong> ${json.medicine_suggested}<br>
        📊 <strong>Độ tin cậy AI:</strong> ${(json.confidence * 100).toFixed(
          2
        )}% ± ${(json.uncertainty * 100).toFixed(2)}%
      `;
      });
    </script>
  </body>
</html>
